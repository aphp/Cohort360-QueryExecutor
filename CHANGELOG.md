# Changelog

All notable changes to this project will be documented in this file.

## [2.10.0] - 2025-07-01

### üöÄ Features

- *(count)* Compute ratio for mode option detail ratio
- *(create)* Add new createDiff mode (#12)

### üêõ Bug Fixes

- *(temporalConstraints)* Forward rename the encounter column to the upper group
- *(jobmanager)* Return cancelled job status on cancel request
- *(config)* Typo useSourcePopulationOnPatient
- *(scripts)* Release script
- *(querybuilder)* Add resource type to new patient criteria tags
- *(countdetails)* Cast to double for ratio calculation
- *(jobs)* Properly cancel job
- *(job)* Prevent autoretry of cancelled jobs
- Spark session in tests
- *(patientAge)* Prevent computing patient age when all fields are empty
- *(pgoutput)* Send error logs to the driver
- *(cohortCreation)* Remove optional delete column

### üìö Documentation

- Add CLAUDE file

### üß™ Testing

- Add some coverage for job manager
- Move chronological order into subgroup

### ‚öôÔ∏è Miscellaneous Tasks

- Update base run image

<!-- generated by git-cliff -->

## [2.9.0] - 2025-03-02

### üöÄ Features

- Add count stage details ratio (#8)
- Add sampled cohort creation (#9)
- *(pgbulk)* Add retry with filtered df for pg output write (#10)
- *(job)* Set KILLED status to cancelled jobserrored
- *(jobs)* Add configurable autoretry
- *(basicResource)* Add unique codes nAmongM filter (#11)

### üêõ Bug Fixes

- *(temporalconstraint)* Allow multistage temporal constraints

### üöú Refactor

- *(sourcePopulation)* Rename to cohortList

### üìö Documentation

- Add authors


## [2.8.0] - 2024-11-21

### üöÄ Features

- *(fhir)* Optional active filter + new cohort list reference
- Add configurable job thread count
- *(cohortcreation)* Add existing cohort update
- Allow partial source population support
- [**breaking**] Remove encounterdaterange and daterange support

### üêõ Bug Fixes

- *(querybuilder)* Wrap exluded criteria in and groups when in or group (#6)
- *(stagecount)* Reverse value for excluded criteria (#7)

### üöú Refactor

- Add configurable List note text column name

### üìö Documentation

- Update changelog

### ‚öôÔ∏è Miscellaneous Tasks

- Add latest tag for main docker build
- Move the build steps in the multistage dockerfile

## [2.7.0] - 2024-07-12

### üöÄ Features

- *(resolver)* Add resolver options + auth token for fhirresolver
- Add stage criteria sub counts (#5)
- Enable constraint on all criteria to be applied to all sub groups

### üêõ Bug Fixes

- *(fhirresolver)* Set correct security param name
- *(jobmanager)* Update parser with new job model
- *(fhirresolver)* Set _count to batch size
- *(logging)* Criterion tags object logging
- Filter final df to prevent temporal constraint result df to duplicate patiens results

### üìö Documentation

- Add license

### üß™ Testing

- Add input parsing test

### ‚öôÔ∏è Miscellaneous Tasks

- Add github actions (#1)
- Add docker publish (#2)
- Add workflow for tags
- Add branch info + limit build to main/tags and PR (#4)
- Fix build for tags
- Add some logs to rest fhir resolver

# [2.6.0] (2024-06-28)


### Bug Fixes

* **imagingstudy:** add group by column and deduplicate resource on it ([8c79c02](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/8c79c02fa063e020d04491e70c3c6d840f81a58d))


### Features

* add fhir resource name mapping to solr collection ([c0b0a24](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/c0b0a24bb485d02457b0f11da49bfc0cfdc9dc05))
* add option to skip source population filter ([2f56bf3](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/2f56bf3b555ad92880c1a13315b267a765bdec57))
* **cohort:** add fhir cohort creation ([32d55cc](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/32d55cc287031c56ef7ef4fff25eefc0cf18ebc5))
* **fhirresolver:** add auth token option ([f6c6eb0](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/f6c6eb0946dc40ec794629d57f1760a97cc51c30))
* **fhirresolver:** add encounter and patient joins ([3195da6](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/3195da68d0aff42197480d3cb86b870cbfe4ee8a))
* **fhirrestresolver:** add basic fhir rest resolver + small solr resolver refacto ([0817264](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/08172644779c9b3c7e292293f60ba72916fd32dc))



## [2.5.1](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/compare/2.4.0...2.5.1) (2024-06-03)


### Bug Fixes

* **create:** add distinct at the end of the cohort creation process ([9b8aba7](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/9b8aba7405160321a1de4f9976a9c862e9833e00))
* **parser:** allow empty group criteria in request ([85abe11](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/85abe11eea55c75e74763e7c2f24ecb22fb45802))
* **queryjson:** change occurence type from short to int ([d062a2a](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/d062a2ae11c8f19a9a8de9e4f3167778f958f5b5))


### Features

* **basicResource:** add crosscollection join for _list when cohort is not fully indexed ([afbe510](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/afbe51067cb7adf70201d8494fb8a7d0f94c3d4d))
* **cohortCreate:** readd other resources types ([49c0af8](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/49c0af8a3a8957d9bb3aa025e1151e3a34e3f1cc))
* **cohortCreation:** prevent solr upload of non Patient cohorts ([b62d379](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/b62d379a7650373ba42c93ef7f42b2b17aa6c286))
* **cohortCreation:** remove long pending status for non patient cohorts ([48e431c](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/48e431c9cc27bd5105e0d01ff394a1cecd4e0458))
* **occurenceFilter:** add groupby column for exploded collections (eg. imagingStudy) ([63bcca7](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/63bcca74aae7c7acb2149a55f02b05c79025d26f))
* **omoptools:** add configurable cohort table names ([f8efa67](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/f8efa67f4aaf8f188f7af7ec1e4f9f65f04f45aa))



# [2.4.0](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/compare/2.3.2...2.4.0) (2024-02-26)


### Bug Fixes

* **jobmanager:** remove non ascii character in error message ([12dcfb6](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/12dcfb6a3341b61318c97791c3a2090d20e53d3e))
* set status and provider name when creating a new row in List table ([f38fec5](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/f38fec5aa08f6c59ae374f973383a007cc2c6593))
* **temporalconstraint:** add check to filter only resource with episode of care for this kind of tc ([1048124](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/1048124342900adbe20199ac11b8bad402852b0e))


### Features

* add questionnaire response query ([d0aad1c](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/d0aad1c9b6cc5cd81ad8fc47f1d3a452636842e5))
* **spark:** add executor memory config ([5d0d403](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/5d0d4035afead697472fd599001ffe2a95bc1af0))



## [2.3.2] (2024-01-18)


### Bug Fixes

* add security in fq criteria for patient feed empty inclusive ([3bedc1a](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/3bedc1a538807fab267252d985207ea526c15e39))
* add wrapping super group when root group is non inclusive ([1108d3f](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/1108d3fb9435c9a580386f69c9c7c13cb26b4f16))
* correct sparkjobparam parsing ([91eb335](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/91eb335df5f9d9e7792f5800d59601df428c5571))
* **ipplist:** add opposed subject filter for ipplist resource ([e357635](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/e357635fa32df2cb9f86175b8fe4090c5bbe5a9c))
* **temporalconstraint:** check intersection instead of ordered slice match for criteria group tmp constraint ([546139a](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/546139ac1377db29ec5ae3595188e3204ddc41d9))


### Features

* add count with organization details ([f34f5f4](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/f34f5f43caa0cae31ddf0a0e42a1329047fc6752))
* **jobs:** add new callbackPath arg for callback overriding ([33eebd7](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/33eebd7fc7ca5c0213b0caf9fd4d04b02b855e64))
* **queryparser:** add raw query log ([f64ea49](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/f64ea497b7cc8a91cbde6c81c946a84561d866fa))



# [2.3.0] (2023-10-13)


### Bug Fixes

* column encounter date mapping ([f313967](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/f3139674354d955017ac3b17e6cf2eb2c3c5bb75))
* name of observation date col ([fa390bf](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/fa390bf1fbf30a26a7c453929688f7531c8c0c48))


### Features

* add total count processing time ([c7866cf](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/c7866cfffdf98810e226489dbe057167c60015dd))
* **imaging:** add imaging resource config ([aa3f64d](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/aa3f64d7153ea9c8a428711968511c4142ddbf7d))
* **job:** add error message ([9451b09](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/9451b09f39bb8966acf8662322a65712c9109cec))
* **jobs:** add optional PATCH callback url for jobs result ([a736037](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/a73603752e028484061c03db32d20b6a1027395b))
* **jobs:** change job result format ([08afdaf](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/08afdaf813745ab3a2940ce31672693190c2ac09))
* update create mode to support basic resource filter cohort creation ([d26e13c](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/d26e13cf20ea08a303b3abc169c9d7d811cf8488))



## [2.1.1] (2023-08-11)


### Bug Fixes

* add last update datetime to group aphp solr insert ([6ab6a1f](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/6ab6a1fdc423eb9b510917b22266cce3aff7dc91))
* cast column to timestamp for interval to work in temporal constraint ([aa92ca3](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/aa92ca31e14c132f73c934caab40473a43b92af0))
* change job status result to a list ([4e486ed](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/4e486edd8020edae2f75e0d9d0f44d9be110b6db))
* **config:** readd composition collection mapping for backward compatibilty ([37b0a3c](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/37b0a3c63c9a32656955456aede25de971596850))
* encounter patient col name ([991d395](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/991d39537a3f107de0809de6db7ba1753f1db497))
* encounter patient col name reference refactor r4 ([3dcd5dc](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/3dcd5dcd22d84909ed13afb90b5fe820676a7d5b))
* encounter patient col name reference refactor r4 ([f8a9a09](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/f8a9a09774d8e5db2637e2441a32bd8fc47ecf9e))
* **jobmanager:** remove option type in job status message ([2cf1bdd](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/2cf1bddc2b588769886bbbfaddfff3bea995df28))
* large cohorts are linked to patients in postgresql ([6cb5a64](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/6cb5a643e20f4ff10879be1e7f33fe64d4db819c))
* **pgtool:** set a writable tmp path ([58dda6a](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/58dda6a4f0dee980a9d50aabc51fdca20f9ee58c))
* readd count_all mode job routing ([72d0cb4](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/72d0cb45c636f98908e735e51513a86c4f371f91))
* result value in failed jobs ([ea75021](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/ea75021077ff1e665c248b840da0e644af83ee4f))
* set new spark user ([0195807](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/0195807ca8b2531ac6afc82242ad8e64848396c7))
* sql IS NULL replaced with column dsl ([9365aca](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/9365aca946aadc751c1c398e63ab4e9dada9c0f5))


### Features

* add json logging ([f2aecf9](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/f2aecf9e5b0c9f912545d9fcdfd36ffd433eddca))
* **parser:** relocate id based temporal constraints to proper sub group ([13cf615](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/13cf61522a612ebe056ecebc0217251ab637eab2))
* set spark scheduling to FAIR ([6698247](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/669824758a9cf7033429f9d6a6e900d2f0a03aa7))
* **spark:** add fair scheduled pool ([73acb61](https://gitlab.data.aphp.fr/ID/pfm/portails-et-apis/cohort360/spark-job-server/commit/73acb61595e62ecfb7dc73363999c687ad4557c0))

